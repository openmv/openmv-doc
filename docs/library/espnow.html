<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>espnow — support for the ESP-NOW wireless protocol &mdash; MicroPython 1.22 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=d5a28fe3" />
      <link rel="stylesheet" href="../_static/customstyle.css" type="text/css" />

  
    <link rel="shortcut icon" href="../_static/openmv.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=f8c2205d"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            MicroPython
              <img src="../_static/web-logo-sticky.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.22
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">MicroPython libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">MicroPython language and implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genrst/index.html">MicroPython differences from CPython</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">MicroPython license information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openmvcam/quickref.html">Quick reference for the openmvcam</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MicroPython</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><code class="xref py py-mod docutils literal notranslate"><span class="pre">espnow</span></code> — support for the ESP-NOW wireless protocol</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/library/espnow.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-espnow">
<span id="espnow-support-for-the-esp-now-wireless-protocol"></span><h1><a class="reference internal" href="#module-espnow" title="espnow: ESP-NOW wireless protocol support"><code class="xref py py-mod docutils literal notranslate"><span class="pre">espnow</span></code></a> — support for the ESP-NOW wireless protocol<a class="headerlink" href="#module-espnow" title="Permalink to this heading">¶</a></h1>
<p>This module provides an interface to the <a class="reference external" href="https://www.espressif.com/en/products/software/esp-now/overview">ESP-NOW</a> protocol provided by Espressif on
ESP32 and ESP8266 devices (<a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/network/esp_now.html">API docs</a>).</p>
<section id="table-of-contents">
<h2>Table of Contents:<a class="headerlink" href="#table-of-contents" title="Permalink to this heading">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#introduction">Introduction</a></p></li>
<li><p><a class="reference internal" href="#configuration">Configuration</a></p></li>
<li><p><a class="reference internal" href="#sending-and-receiving-data">Sending and Receiving Data</a></p></li>
<li><p><a class="reference internal" href="#peer-management">Peer Management</a></p></li>
<li><p><a class="reference internal" href="#callback-methods">Callback Methods</a></p></li>
<li><p><a class="reference internal" href="#exceptions">Exceptions</a></p></li>
<li><p><a class="reference internal" href="#constants">Constants</a></p></li>
<li><p><a class="reference internal" href="#wifi-signal-strength-rssi-esp32-only">Wifi Signal Strength (RSSI) - (ESP32 Only)</a></p></li>
<li><p><a class="reference internal" href="#supporting-asyncio">Supporting asyncio</a></p></li>
<li><p><a class="reference internal" href="#broadcast-and-multicast">Broadcast and Multicast</a></p></li>
<li><p><a class="reference internal" href="#espnow-and-wifi-operation">ESPNow and Wifi Operation</a></p></li>
<li><p><a class="reference internal" href="#espnow-and-sleep-modes">ESPNow and Sleep Modes</a></p></li>
</ul>
</div></blockquote>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>ESP-NOW is a connection-less wireless communication protocol supporting:</p>
<ul class="simple">
<li><p>Direct communication between up to 20 registered peers:</p>
<ul>
<li><p>Without the need for a wireless access point (AP),</p></li>
</ul>
</li>
<li><p>Encrypted and unencrypted communication (up to 6 encrypted peers),</p></li>
<li><p>Message sizes up to 250 bytes,</p></li>
<li><p>Can operate alongside Wifi operation (<a class="reference internal" href="network.WLAN.html"><span class="doc">network.WLAN</span></a>) on
ESP32 and ESP8266 devices.</p></li>
</ul>
<p>It is especially useful for small IoT networks, latency sensitive or power
sensitive applications (such as battery operated devices) and for long-range
communication between devices (hundreds of metres).</p>
<p>This module also supports tracking the Wifi signal strength (RSSI) of peer
devices.</p>
<p>A simple example would be:</p>
<p><strong>Sender:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span>
<span class="kn">import</span> <span class="nn">espnow</span>

<span class="c1"># A WLAN interface must be active to send()/recv()</span>
<span class="n">sta</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span>  <span class="c1"># Or network.AP_IF</span>
<span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sta</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>      <span class="c1"># For ESP8266</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">espnow</span><span class="o">.</span><span class="n">ESPNow</span><span class="p">()</span>
<span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">peer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xbb\xbb\xbb\xbb\xbb\xbb</span><span class="s1">&#39;</span>   <span class="c1"># MAC address of peer&#39;s wifi interface</span>
<span class="n">e</span><span class="o">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>      <span class="c1"># Must add_peer() before send()</span>

<span class="n">e</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="s2">&quot;Starting...&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">e</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Receiver:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span>
<span class="kn">import</span> <span class="nn">espnow</span>

<span class="c1"># A WLAN interface must be active to send()/recv()</span>
<span class="n">sta</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span>
<span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sta</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>   <span class="c1"># Because ESP8266 auto-connects to last Access Point</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">espnow</span><span class="o">.</span><span class="n">ESPNow</span><span class="p">()</span>
<span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>             <span class="c1"># msg == None if timeout in recv()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;end&#39;</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>
</div>
</section>
<section id="class-espnow">
<h2>class ESPNow<a class="headerlink" href="#class-espnow" title="Permalink to this heading">¶</a></h2>
</section>
<section id="constructor">
<h2>Constructor<a class="headerlink" href="#constructor" title="Permalink to this heading">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="espnow.ESPNow">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">espnow.</span></span><span class="sig-name descname"><span class="pre">ESPNow</span></span><a class="headerlink" href="#espnow.ESPNow" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the singleton ESPNow object. As this is a singleton, all calls to
<a class="reference internal" href="#espnow.ESPNow" title="espnow.ESPNow"><code class="xref any py py-class docutils literal notranslate"><span class="pre">espnow.ESPNow()</span></code></a> return a reference to the same object.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some methods are available only on the ESP32 due to code size
restrictions on the ESP8266 and differences in the Espressif API.</p>
</div>
</dd></dl>

</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.active">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">active</span></span><span class="sig-paren">(</span><span class="optional">[</span><em class="sig-param"><span class="n"><span class="pre">flag</span></span></em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.active" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialise or de-initialise the ESP-NOW communication protocol depending on
the value of the <code class="docutils literal notranslate"><span class="pre">flag</span></code> optional argument.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Arguments:</span></span></dt>
<dd><ul class="simple">
<li><p><em>flag</em>: Any python value which can be converted to a boolean type.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: Prepare the software and hardware for use of the ESP-NOW
communication protocol, including:</p>
<ul>
<li><p>initialise the ESPNow data structures,</p></li>
<li><p>allocate the recv data buffer,</p></li>
<li><p>invoke esp_now_init() and</p></li>
<li><p>register the send and recv callbacks.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: De-initialise the Espressif ESP-NOW software stack
(esp_now_deinit()), disable callbacks, deallocate the recv
data buffer and deregister all peers.</p></li>
</ul>
</li>
</ul>
</dd></dl>

<p>If <em>flag</em> is not provided, return the current status of the ESPNow
interface.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">True</span></code> if interface is currently <em>active</em>, else <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.config">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">config</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">param=value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">...</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.config" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">config</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">'param')</span>&#160;&#160; <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Set or get configuration values of the ESPNow interface. To set values, use
the keyword syntax, and one or more parameters can be set at a time. To get
a value the parameter name should be quoted as a string, and just one
parameter is queried at a time.</p>
<p><strong>Note:</strong> <em>Getting</em> parameters is not supported on the ESP8266.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Options:</span></span></dt>
<dd><p><em>rxbuf</em>: (default=526) Get/set the size in bytes of the internal
buffer used to store incoming ESPNow packet data. The default size is
selected to fit two max-sized ESPNow packets (250 bytes) with associated
mac_address (6 bytes), a message byte count (1 byte) and RSSI data plus
buffer overhead. Increase this if you expect to receive a lot of large
packets or expect bursty incoming traffic.</p>
<p><strong>Note:</strong> The recv buffer is allocated by <a class="reference internal" href="#espnow.ESPNow.active" title="espnow.ESPNow.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.active()</span></code></a>. Changing
this value will have no effect until the next call of
<a class="reference internal" href="#espnow.ESPNow.active" title="espnow.ESPNow.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.active(True)</span></code></a>.</p>
<p><em>timeout_ms</em>: (default=300,000) Default timeout (in milliseconds)
for receiving ESPNow messages. If <em>timeout_ms</em> is less than zero, then
wait forever. The timeout can also be provided as arg to
<a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a>/<a class="reference internal" href="#espnow.ESPNow.irecv" title="espnow.ESPNow.irecv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">irecv()</span></code></a>/<a class="reference internal" href="#espnow.ESPNow.recvinto" title="espnow.ESPNow.recvinto"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">recvinto()</span></code></a>.</p>
<p><em>rate</em>: (ESP32 only, IDF&gt;=4.3.0 only) Set the transmission speed for
ESPNow packets. Must be set to a number from the allowed numeric values
in <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/v4.4.1/esp32/api-reference/network/esp_wifi.html#_CPPv415wifi_phy_rate_t">enum wifi_phy_rate_t</a>.</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">None</span></code> or the value of the parameter being queried.</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_INIT&quot;)</span></code> if not initialised.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ValueError()</span></code> on invalid configuration options or values.</p></li>
</ul>
</dd></dl>

</dd></dl>

</section>
<section id="sending-and-receiving-data">
<h2>Sending and Receiving Data<a class="headerlink" href="#sending-and-receiving-data" title="Permalink to this heading">¶</a></h2>
<p>A wifi interface (<code class="docutils literal notranslate"><span class="pre">network.STA_IF</span></code> or <code class="docutils literal notranslate"><span class="pre">network.AP_IF</span></code>) must be
<a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active()</span></code></a> before messages can be sent or received,
but it is not necessary to connect or configure the WLAN interface.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span>

<span class="n">sta</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span>
<span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sta</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>    <span class="c1"># For ESP8266</span>
</pre></div>
</div>
<p><strong>Note:</strong> The ESP8266 has a <em>feature</em> that causes it to automatically reconnect
to the last wifi Access Point when set <a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active(True)</span></code></a> (even
after reboot/reset). This reduces the reliability of receiving ESP-NOW messages
(see <a class="reference internal" href="#espnow-and-wifi-operation">ESPNow and Wifi Operation</a>). You can avoid this by calling
<a class="reference internal" href="network.WLAN.html#network.WLAN.disconnect" title="network.WLAN.disconnect"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">disconnect()</span></code></a> after
<a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active(True)</span></code></a>.</p>
<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.send">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">send</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mac</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">msg</span></span></em><span class="optional">[</span>, <em class="sig-param"><span class="n"><span class="pre">sync</span></span></em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.send" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">send</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">msg)</span>&#160;&#160; <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Send the data contained in <code class="docutils literal notranslate"><span class="pre">msg</span></code> to the peer with given network <code class="docutils literal notranslate"><span class="pre">mac</span></code>
address. In the second form, <code class="docutils literal notranslate"><span class="pre">mac=None</span></code> and <code class="docutils literal notranslate"><span class="pre">sync=True</span></code>. The peer must
be registered with <a class="reference internal" href="#espnow.ESPNow.add_peer" title="espnow.ESPNow.add_peer"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.add_peer()</span></code></a> before the
message can be sent.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Arguments:</span></span></dt>
<dd><ul class="simple">
<li><p><em>mac</em>: byte string exactly <code class="docutils literal notranslate"><span class="pre">espnow.ADDR_LEN</span></code> (6 bytes) long or
<code class="docutils literal notranslate"><span class="pre">None</span></code>. If <em>mac</em> is <code class="docutils literal notranslate"><span class="pre">None</span></code> (ESP32 only) the message will be sent
to all registered peers, except any broadcast or multicast MAC
addresses.</p></li>
<li><p><em>msg</em>: string or byte-string up to <code class="docutils literal notranslate"><span class="pre">espnow.MAX_DATA_LEN</span></code> (250)
bytes long.</p></li>
<li><p><em>sync</em>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: (default) send <code class="docutils literal notranslate"><span class="pre">msg</span></code> to the peer(s) and wait for a
response (or not).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> send <code class="docutils literal notranslate"><span class="pre">msg</span></code> and return immediately. Responses from the
peers will be discarded.</p></li>
</ul>
</li>
</ul>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">True</span></code> if <code class="docutils literal notranslate"><span class="pre">sync=False</span></code> or if <code class="docutils literal notranslate"><span class="pre">sync=True</span></code> and <em>all</em> peers respond,
else <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_INIT&quot;)</span></code> if not initialised.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_FOUND&quot;)</span></code> if peer is not registered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_IF&quot;)</span></code> the wifi interface is not
<a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active()</span></code></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NO_MEM&quot;)</span></code> internal ESP-NOW buffers are
full.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ValueError()</span></code> on invalid values for the parameters.</p></li>
</ul>
</dd></dl>

<p><strong>Note</strong>: A peer will respond with success if its wifi interface is
<a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active()</span></code></a> and set to the same channel as the sender,
regardless of whether it has initialised it’s ESP-NOW system or is
actively listening for ESP-NOW traffic (see the Espressif ESP-NOW docs).</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.recv">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">recv</span></span><span class="sig-paren">(</span><span class="optional">[</span><em class="sig-param"><span class="n"><span class="pre">timeout_ms</span></span></em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.recv" title="Permalink to this definition">¶</a></dt>
<dd><p>Wait for an incoming message and return the <code class="docutils literal notranslate"><span class="pre">mac</span></code> address of the peer and
the message. <strong>Note</strong>: It is <strong>not</strong> necessary to register a peer (using
<a class="reference internal" href="#espnow.ESPNow.add_peer" title="espnow.ESPNow.add_peer"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">add_peer()</span></code></a>) to receive a message from that peer.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Arguments:</span></span></dt>
<dd><ul class="simple">
<li><p><em>timeout_ms</em>: (Optional): May have the following values.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code>: No timeout. Return immediately if no data is available;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&gt;</span> <span class="pre">0</span></code>: Specify a timeout value in milliseconds;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;</span> <span class="pre">0</span></code>: Do not timeout, ie. wait forever for new messages; or</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> (or not provided): Use the default timeout value set with
<a class="reference internal" href="#espnow.ESPNow.config" title="espnow.ESPNow.config"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.config()</span></code></a>.</p></li>
</ul>
</li>
</ul>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">None)</span></code> if timeout is reached before a message is received, or</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[mac,</span> <span class="pre">msg]</span></code>: where:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mac</span></code> is a bytestring containing the address of the device which
sent the message, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">msg</span></code> is a bytestring containing the message.</p></li>
</ul>
</li>
</ul>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_INIT&quot;)</span></code> if not initialised.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_IF&quot;)</span></code> if the wifi interface is not
<a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active()</span></code></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ValueError()</span></code> on invalid <em>timeout_ms</em> values.</p></li>
</ul>
</dd></dl>

<p><a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a> will allocate new storage for the returned list and the
<code class="docutils literal notranslate"><span class="pre">peer</span></code> and <code class="docutils literal notranslate"><span class="pre">msg</span></code> bytestrings. This can lead to memory fragmentation if
the data rate is high. See <a class="reference internal" href="#espnow.ESPNow.irecv" title="espnow.ESPNow.irecv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.irecv()</span></code></a> for a memory-friendly
alternative.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.irecv">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">irecv</span></span><span class="sig-paren">(</span><span class="optional">[</span><em class="sig-param"><span class="n"><span class="pre">timeout_ms</span></span></em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.irecv" title="Permalink to this definition">¶</a></dt>
<dd><p>Works like <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a> but will reuse internal bytearrays to store the
return values: <code class="docutils literal notranslate"><span class="pre">[mac,</span> <span class="pre">msg]</span></code>, so that no new memory is allocated on each
call.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Arguments:</span></span></dt>
<dd><p><em>timeout_ms</em>: (Optional) Timeout in milliseconds (see <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a>).</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><ul class="simple">
<li><p>As for <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a>, except that <code class="docutils literal notranslate"><span class="pre">msg</span></code> is a bytearray, instead of
a bytestring. On the ESP8266, <code class="docutils literal notranslate"><span class="pre">mac</span></code> will also be a bytearray.</p></li>
</ul>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><ul class="simple">
<li><p>See <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a>.</p></li>
</ul>
</dd></dl>

<p><strong>Note:</strong> You may also read messages by iterating over the ESPNow object,
which will use the <a class="reference internal" href="#espnow.ESPNow.irecv" title="espnow.ESPNow.irecv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">irecv()</span></code></a> method for alloc-free reads, eg:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">espnow</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">espnow</span><span class="o">.</span><span class="n">ESPNow</span><span class="p">();</span> <span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mac</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1"># mac, msg will equal (None, None) on timeout</span>
        <span class="k">break</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.recvinto">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">recvinto</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data</span></span></em><span class="optional">[</span>, <em class="sig-param"><span class="n"><span class="pre">timeout_ms</span></span></em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.recvinto" title="Permalink to this definition">¶</a></dt>
<dd><p>Wait for an incoming message and return the length of the message in bytes.
This is the low-level method used by both <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a> and
<a class="reference internal" href="#espnow.ESPNow.irecv" title="espnow.ESPNow.irecv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">irecv()</span></code></a> to read messages.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Arguments:</span></span></dt>
<dd><p><em>data</em>: A list of at least two elements, <code class="docutils literal notranslate"><span class="pre">[peer,</span> <span class="pre">msg]</span></code>. <code class="docutils literal notranslate"><span class="pre">msg</span></code> must
be a bytearray large enough to hold the message (250 bytes). On the
ESP8266, <code class="docutils literal notranslate"><span class="pre">peer</span></code> should be a bytearray of 6 bytes. The MAC address of
the sender and the message will be stored in these bytearrays (see Note
on ESP32 below).</p>
<p><em>timeout_ms</em>: (Optional) Timeout in milliseconds (see <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a>).</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><ul class="simple">
<li><p>Length of message in bytes or 0 if <em>timeout_ms</em> is reached before a
message is received.</p></li>
</ul>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><ul class="simple">
<li><p>See <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a>.</p></li>
</ul>
</dd></dl>

<p><strong>Note:</strong> On the ESP32:</p>
<ul class="simple">
<li><p>It is unnecessary to provide a bytearray in the first element of the
<code class="docutils literal notranslate"><span class="pre">data</span></code> list because it will be replaced by a reference to a unique
<code class="docutils literal notranslate"><span class="pre">peer</span></code> address in the <strong>peer device table</strong> (see <a class="reference internal" href="#espnow.ESPNow.peers_table" title="espnow.ESPNow.peers_table"><code class="xref any py py-data docutils literal notranslate"><span class="pre">ESPNow.peers_table</span></code></a>).</p></li>
<li><p>If the list is at least 4 elements long, the rssi and timestamp values
will be saved as the 3rd and 4th elements.</p></li>
</ul>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.any">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">any</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.any" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if data is available to be read with <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a>.</p>
<p>For more sophisticated querying of available characters use <a class="reference internal" href="select.html#select.poll" title="select.poll"><code class="xref any py py-func docutils literal notranslate"><span class="pre">select.poll()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">espnow</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">espnow</span><span class="o">.</span><span class="n">ESPNow</span><span class="p">()</span>
<span class="n">poll</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
<span class="n">poll</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
<span class="n">poll</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</pre></div>
</div>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">True</span></code> if data is available to be read, else <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.stats">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">stats</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">)</span> <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.stats" title="Permalink to this definition">¶</a></dt>
<dd><dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><p>A 5-tuple containing the number of packets sent/received/lost:</p>
<p><code class="docutils literal notranslate"><span class="pre">(tx_pkts,</span> <span class="pre">tx_responses,</span> <span class="pre">tx_failures,</span> <span class="pre">rx_packets,</span> <span class="pre">rx_dropped_packets)</span></code></p>
</dd></dl>

<p>Incoming packets are <em>dropped</em> when the recv buffers are full. To reduce
packet loss, increase the <code class="docutils literal notranslate"><span class="pre">rxbuf</span></code> config parameters and ensure you are
reading messages as quickly as possible.</p>
<p><strong>Note</strong>: Dropped packets will still be acknowledged to the sender as
received.</p>
</dd></dl>

</section>
<section id="peer-management">
<h2>Peer Management<a class="headerlink" href="#peer-management" title="Permalink to this heading">¶</a></h2>
<p>On ESP32 devices, the Espressif ESP-NOW software requires that other devices
(peers) must be <em>registered</em> using <a class="reference internal" href="#espnow.ESPNow.add_peer" title="espnow.ESPNow.add_peer"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">add_peer()</span></code></a> before we can
<a class="reference internal" href="#espnow.ESPNow.send" title="espnow.ESPNow.send"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> them messages (this is <em>not</em> enforced on ESP8266
devices). It is <strong>not</strong> necessary to register a peer to receive an
un-encrypted message from that peer.</p>
<p><strong>Encrypted messages</strong>: To receive an <em>encrypted</em> message, the receiving device
must first register the sender and use the same encryption keys as the sender
(PMK and LMK) (see <a class="reference internal" href="#espnow.ESPNow.set_pmk" title="espnow.ESPNow.set_pmk"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">set_pmk()</span></code></a> and <a class="reference internal" href="#espnow.ESPNow.add_peer" title="espnow.ESPNow.add_peer"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">add_peer()</span></code></a>.</p>
<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.set_pmk">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">set_pmk</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pmk</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.set_pmk" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the Primary Master Key (PMK) which is used to encrypt the Local Master
Keys (LMK) for encrypting messages. If this is not set, a default PMK is
used by the underlying Espressif ESP-NOW software stack.</p>
<p><strong>Note:</strong> messages will only be encrypted if <em>lmk</em> is also set in
<a class="reference internal" href="#espnow.ESPNow.add_peer" title="espnow.ESPNow.add_peer"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.add_peer()</span></code></a> (see <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_now.html#security">Security</a> in the Espressif API
docs).</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Arguments:</span></span></dt>
<dd><p><em>pmk</em>: Must be a byte string, bytearray or string of length
<a class="reference internal" href="#espnow.espnow.KEY_LEN" title="espnow.espnow.KEY_LEN"><code class="xref any py py-data docutils literal notranslate"><span class="pre">espnow.KEY_LEN</span></code></a> (16 bytes).</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">ValueError()</span></code> on invalid <em>pmk</em> values.</p>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.add_peer">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">add_peer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mac</span></span></em><span class="optional">[</span>, <em class="sig-param"><span class="n"><span class="pre">lmk</span></span></em><span class="optional">]</span><span class="optional">[</span>, <em class="sig-param"><span class="n"><span class="pre">channel</span></span></em><span class="optional">]</span><span class="optional">[</span>, <em class="sig-param"><span class="n"><span class="pre">ifidx</span></span></em><span class="optional">]</span><span class="optional">[</span>, <em class="sig-param"><span class="n"><span class="pre">encrypt</span></span></em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.add_peer" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">add_peer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mac</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">param=value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">...)</span>&#160;&#160; <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Add/register the provided <em>mac</em> address as a peer. Additional parameters may
also be specified as positional or keyword arguments (any parameter set to
<code class="docutils literal notranslate"><span class="pre">None</span></code> will be set to it’s default value):</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Arguments:</span></span></dt>
<dd><ul class="simple">
<li><p><em>mac</em>: The MAC address of the peer (as a 6-byte byte-string).</p></li>
<li><p><em>lmk</em>: The Local Master Key (LMK) key used to encrypt data
transfers with this peer (unless the <em>encrypt</em> parameter is set to
<code class="docutils literal notranslate"><span class="pre">False</span></code>). Must be:</p>
<ul>
<li><p>a byte-string or bytearray or string of length <code class="docutils literal notranslate"><span class="pre">espnow.KEY_LEN</span></code>
(16 bytes), or</p></li>
<li><p>any non <code class="docutils literal notranslate"><span class="pre">True</span></code> python value (default= <code class="docutils literal notranslate"><span class="pre">b''</span></code>), signifying an
<em>empty</em> key which will disable encryption.</p></li>
</ul>
</li>
<li><p><em>channel</em>: The wifi channel (2.4GHz) to communicate with this peer.
Must be an integer from 0 to 14. If channel is set to 0 the current
channel of the wifi device will be used. (default=0)</p></li>
<li><p><em>ifidx</em>: (ESP32 only) Index of the wifi interface which will be
used to send data to this peer. Must be an integer set to
<code class="docutils literal notranslate"><span class="pre">network.STA_IF</span></code> (=0) or <code class="docutils literal notranslate"><span class="pre">network.AP_IF</span></code> (=1).
(default=0/<code class="docutils literal notranslate"><span class="pre">network.STA_IF</span></code>). See <a class="reference internal" href="#espnow-and-wifi-operation">ESPNow and Wifi Operation</a>
below for more information.</p></li>
<li><p><em>encrypt</em>: (ESP32 only) If set to <code class="docutils literal notranslate"><span class="pre">True</span></code> data exchanged with
this peer will be encrypted with the PMK and LMK. (default =
<code class="docutils literal notranslate"><span class="pre">True</span></code> if <em>lmk</em> is set to a valid key, else <code class="docutils literal notranslate"><span class="pre">False</span></code>)</p></li>
</ul>
<p><strong>ESP8266</strong>: Keyword args may not be used on the ESP8266.</p>
<p><strong>Note:</strong> The maximum number of peers which may be registered is 20
(<a class="reference internal" href="#espnow.espnow.MAX_TOTAL_PEER_NUM" title="espnow.espnow.MAX_TOTAL_PEER_NUM"><code class="xref any py py-data docutils literal notranslate"><span class="pre">espnow.MAX_TOTAL_PEER_NUM</span></code></a>), with a maximum of 6
(<a class="reference internal" href="#espnow.espnow.MAX_ENCRYPT_PEER_NUM" title="espnow.espnow.MAX_ENCRYPT_PEER_NUM"><code class="xref any py py-data docutils literal notranslate"><span class="pre">espnow.MAX_ENCRYPT_PEER_NUM</span></code></a>) of those peers with encryption enabled
(see <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_now.html#c.ESP_NOW_MAX_ENCRYPT_PEER_NUM">ESP_NOW_MAX_ENCRYPT_PEER_NUM</a> in the Espressif API
docs).</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_INIT&quot;)</span></code> if not initialised.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_EXIST&quot;)</span></code> if <em>mac</em> is already
registered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_FULL&quot;)</span></code> if too many peers are
already registered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ValueError()</span></code> on invalid keyword args or values.</p></li>
</ul>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.del_peer">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">del_peer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mac</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.del_peer" title="Permalink to this definition">¶</a></dt>
<dd><p>Deregister the peer associated with the provided <em>mac</em> address.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_INIT&quot;)</span></code> if not initialised.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_FOUND&quot;)</span></code> if <em>mac</em> is not
registered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ValueError()</span></code> on invalid <em>mac</em> values.</p></li>
</ul>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.get_peer">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">get_peer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mac)</span> <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.get_peer" title="Permalink to this definition">¶</a></dt>
<dd><p>Return information on a registered peer.</p>
<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Returns:</span></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">(mac,</span> <span class="pre">lmk,</span> <span class="pre">channel,</span> <span class="pre">ifidx,</span> <span class="pre">encrypt)</span></code>: a tuple of the “peer
info” associated with the given <em>mac</em> address.</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">Raises:</span></span></dt>
<dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_INIT&quot;)</span></code> if not initialised.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OSError(num,</span> <span class="pre">&quot;ESP_ERR_ESPNOW_NOT_FOUND&quot;)</span></code> if <em>mac</em> is not
registered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ValueError()</span></code> on invalid <em>mac</em> values.</p></li>
</ul>
</dd></dl>

</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.peer_count">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">peer_count</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">)</span> <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.peer_count" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the number of registered peers:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(peer_num,</span> <span class="pre">encrypt_num)</span></code>: where</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">peer_num</span></code> is the number of peers which are registered, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">encrypt_num</span></code> is the number of encrypted peers.</p></li>
</ul>
</li>
</ul>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.get_peers">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">get_peers</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">)</span> <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.get_peers" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the “peer info” parameters for all the registered peers (as a tuple
of tuples).</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.mod_peer">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">mod_peer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">mac,</span> <span class="pre">lmk,</span> <span class="pre">[channel],</span> <span class="pre">[ifidx],</span> <span class="pre">[encrypt])</span> <span class="pre">(ESP32</span> <span class="pre">only</span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.mod_peer" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">mod_peer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mac</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">'param'=value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">...)</span> <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Modify the parameters of the peer associated with the provided <em>mac</em>
address. Parameters may be provided as positional or keyword arguments
(see <a class="reference internal" href="#espnow.ESPNow.add_peer" title="espnow.ESPNow.add_peer"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.add_peer()</span></code></a>). Any parameter that is not set (or set to
<code class="docutils literal notranslate"><span class="pre">None</span></code>) will retain the existing value for that parameter.</p>
</dd></dl>

</section>
<section id="callback-methods">
<h2>Callback Methods<a class="headerlink" href="#callback-methods" title="Permalink to this heading">¶</a></h2>
<dl class="py method">
<dt class="sig sig-object py" id="espnow.ESPNow.irq">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">irq</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">callback)</span> <span class="pre">(ESP32</span> <span class="pre">only</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.ESPNow.irq" title="Permalink to this definition">¶</a></dt>
<dd><p>Set a callback function to be called <em>as soon as possible</em> after a message has
been received from another ESPNow device. The callback function will be called
with the <a class="reference internal" href="#espnow.ESPNow" title="espnow.ESPNow"><code class="xref any py py-class docutils literal notranslate"><span class="pre">ESPNow</span></code></a> instance object as an argument. For more reliable operation,
it is recommended to read out as many messages as are available when the
callback is invoked and to set the read timeout to zero, eg:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">recv_cb</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Read out all messages waiting in the buffer</span>
        <span class="n">mac</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">irecv</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Don&#39;t wait if no messages left</span>
        <span class="k">if</span> <span class="n">mac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">irq</span><span class="p">(</span><span class="n">recv_cb</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="#espnow.ESPNow.irq" title="espnow.ESPNow.irq"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">irq()</span></code></a> callback method is an alternative method for
processing incoming messages, especially if the data rate is moderate
and the device is <em>not too busy</em> but there are some caveats:</p>
<ul class="simple">
<li><p>The scheduler stack <em>can</em> overflow and callbacks will be missed if
packets are arriving at a sufficient rate or if other MicroPython components
(eg, bluetooth, machine.Pin.irq(), machine.timer, i2s, …) are exercising
the scheduler stack. This method may be less reliable for dealing with
bursts of messages, or high throughput or on a device which is busy dealing
with other hardware operations.</p></li>
<li><p>For more information on <em>scheduled</em> function callbacks see:
<a class="reference internal" href="micropython.html#micropython.schedule" title="micropython.schedule"><code class="xref any py py-func docutils literal notranslate"><span class="pre">micropython.schedule()</span></code></a>.</p></li>
</ul>
</dd></dl>

</section>
<section id="constants">
<h2>Constants<a class="headerlink" href="#constants" title="Permalink to this heading">¶</a></h2>
<dl class="py data">
<dt class="sig sig-object py" id="espnow.espnow.MAX_DATA_LEN">
<span class="sig-prename descclassname"><span class="pre">espnow.</span></span><span class="sig-name descname"><span class="pre">MAX_DATA_LEN</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">=250</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.espnow.MAX_DATA_LEN" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object py" id="espnow.espnow.KEY_LEN">
<span class="sig-prename descclassname"><span class="pre">espnow.</span></span><span class="sig-name descname"><span class="pre">KEY_LEN</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">=16</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.espnow.KEY_LEN" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object py" id="espnow.espnow.ADDR_LEN">
<span class="sig-prename descclassname"><span class="pre">espnow.</span></span><span class="sig-name descname"><span class="pre">ADDR_LEN</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">=6</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.espnow.ADDR_LEN" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object py" id="espnow.espnow.MAX_TOTAL_PEER_NUM">
<span class="sig-prename descclassname"><span class="pre">espnow.</span></span><span class="sig-name descname"><span class="pre">MAX_TOTAL_PEER_NUM</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">=20</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.espnow.MAX_TOTAL_PEER_NUM" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object py" id="espnow.espnow.MAX_ENCRYPT_PEER_NUM">
<span class="sig-prename descclassname"><span class="pre">espnow.</span></span><span class="sig-name descname"><span class="pre">MAX_ENCRYPT_PEER_NUM</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">=6</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#espnow.espnow.MAX_ENCRYPT_PEER_NUM" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</section>
<section id="exceptions">
<h2>Exceptions<a class="headerlink" href="#exceptions" title="Permalink to this heading">¶</a></h2>
<p>If the underlying Espressif ESP-NOW software stack returns an error code,
the MicroPython espnow module will raise an <code class="docutils literal notranslate"><span class="pre">OSError(errnum,</span> <span class="pre">errstring)</span></code>
exception where <code class="docutils literal notranslate"><span class="pre">errstring</span></code> is set to the name of one of the error codes
identified in the
<a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/network/esp_now.html#api-reference">Espressif ESP-NOW docs</a>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">e</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="s1">&#39;Hello&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">err</span>
    <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ESP_ERR_ESPNOW_NOT_INIT&#39;</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ESP_ERR_ESPNOW_NOT_FOUND&#39;</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ESP_ERR_ESPNOW_IF&#39;</span><span class="p">:</span>
        <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">err</span>
</pre></div>
</div>
</section>
<section id="wifi-signal-strength-rssi-esp32-only">
<h2>Wifi Signal Strength (RSSI) - (ESP32 only)<a class="headerlink" href="#wifi-signal-strength-rssi-esp32-only" title="Permalink to this heading">¶</a></h2>
<p>The ESPNow object maintains a <strong>peer device table</strong> which contains the signal
strength and timestamp of the last received message from all hosts. The <strong>peer
device table</strong> can be accessed using <a class="reference internal" href="#espnow.ESPNow.peers_table" title="espnow.ESPNow.peers_table"><code class="xref any py py-data docutils literal notranslate"><span class="pre">ESPNow.peers_table</span></code></a> and can be used to
track device proximity and identify <em>nearest neighbours</em> in a network of peer
devices. This feature is <strong>not</strong> available on ESP8266 devices.</p>
<dl class="py data">
<dt class="sig sig-object py" id="espnow.ESPNow.peers_table">
<span class="sig-prename descclassname"><span class="pre">ESPNow.</span></span><span class="sig-name descname"><span class="pre">peers_table</span></span><a class="headerlink" href="#espnow.ESPNow.peers_table" title="Permalink to this definition">¶</a></dt>
<dd><p>A reference to the <strong>peer device table</strong>: a dict of known peer devices
and rssi values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">peer</span><span class="p">:</span> <span class="p">[</span><span class="n">rssi</span><span class="p">,</span> <span class="n">time_ms</span><span class="p">],</span> <span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">peer</span></code> is the peer MAC address (as <a class="reference internal" href="builtins.html#bytes" title="bytes"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a>);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rssi</span></code> is the wifi signal strength in dBm (-127 to 0) of the last
message received from the peer; and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">time_ms</span></code> is the time the message was received (in milliseconds since
system boot - wraps every 12 days).</p></li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">e</span><span class="o">.</span><span class="n">peers_table</span>
<span class="go">{b&#39;\xaa\xaa\xaa\xaa\xaa\xaa&#39;: [-31, 18372],</span>
<span class="go"> b&#39;\xbb\xbb\xbb\xbb\xbb\xbb&#39;: [-43, 12541]}</span>
</pre></div>
</div>
<p><strong>Note</strong>: the <code class="docutils literal notranslate"><span class="pre">mac</span></code> addresses returned by <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">recv()</span></code></a> are references to
the <code class="docutils literal notranslate"><span class="pre">peer</span></code> key values in the <strong>peer device table</strong>.</p>
<p><strong>Note</strong>: RSSI and timestamp values in the device table are updated only
when the message is read by the application.</p>
</dd></dl>

</section>
<section id="supporting-asyncio">
<h2>Supporting asyncio<a class="headerlink" href="#supporting-asyncio" title="Permalink to this heading">¶</a></h2>
<p>A supplementary module (<a class="reference internal" href="#module-aioespnow" title="aioespnow: ESP-NOW :doc:`asyncio` support"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">aioespnow</span></code></a>) is available to provide
<a class="reference internal" href="asyncio.html"><span class="doc">asyncio</span></a> support.</p>
<p><strong>Note:</strong> Asyncio support is available on all ESP32 targets as well as those
ESP8266 boards which include the asyncio module (ie. ESP8266 devices with at
least 2MB flash memory).</p>
<p>A small async server example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span>
<span class="kn">import</span> <span class="nn">aioespnow</span>
<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="c1"># A WLAN interface must be active to send()/recv()</span>
<span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">aioespnow</span><span class="o">.</span><span class="n">AIOESPNow</span><span class="p">()</span>  <span class="c1"># Returns AIOESPNow enhanced with async support</span>
<span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">peer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xbb\xbb\xbb\xbb\xbb\xbb</span><span class="s1">&#39;</span>
<span class="n">e</span><span class="o">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>

<span class="c1"># Send a periodic ping to a peer</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">heartbeat</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">e</span><span class="o">.</span><span class="n">asend</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;ping&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Heartbeat: peer not responding:&quot;</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Heartbeat: ping&quot;</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>

<span class="c1"># Echo any received messages back to the sender</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">echo_server</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">mac</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Echo:&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">e</span><span class="o">.</span><span class="n">asend</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ESP_ERR_ESPNOW_NOT_FOUND&#39;</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">e</span><span class="o">.</span><span class="n">asend</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">heartbeat</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">period</span><span class="p">))</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">echo_server</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<span class="target" id="module-aioespnow"></span><dl class="py class">
<dt class="sig sig-object py" id="aioespnow.AIOESPNow">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">aioespnow.</span></span><span class="sig-name descname"><span class="pre">AIOESPNow</span></span><a class="headerlink" href="#aioespnow.AIOESPNow" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="#aioespnow.AIOESPNow" title="aioespnow.AIOESPNow"><code class="xref any py py-class docutils literal notranslate"><span class="pre">AIOESPNow</span></code></a> class inherits all the methods of <a class="reference internal" href="#espnow.ESPNow" title="espnow.ESPNow"><code class="xref any py py-class docutils literal notranslate"><span class="pre">ESPNow</span></code></a>
and extends the interface with the following async methods.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">async</span> <span class="pre">AIOESPNow.arecv()</span></span></dt>
<dd><p>Asyncio support for <a class="reference internal" href="#espnow.ESPNow.recv" title="espnow.ESPNow.recv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.recv()</span></code></a>. Note that this method does not take a
timeout value as argument.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">async</span> <span class="pre">AIOESPNow.airecv()</span></span></dt>
<dd><p>Asyncio support for <a class="reference internal" href="#espnow.ESPNow.irecv" title="espnow.ESPNow.irecv"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.irecv()</span></code></a>. Note that this method does not take a
timeout value as argument.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">async</span> <span class="pre">AIOESPNow.asend(mac,</span> <span class="pre">msg,</span> <span class="pre">sync=True)</span></span></dt>
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">async</span> <span class="pre">AIOESPNow.asend(msg)</span></span></dt>
<dd><p>Asyncio support for <a class="reference internal" href="#espnow.ESPNow.send" title="espnow.ESPNow.send"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.send()</span></code></a>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="aioespnow.AIOESPNow._aiter__">
<span class="sig-prename descclassname"><span class="pre">AIOESPNow.</span></span><span class="sig-name descname"><span class="pre">_aiter__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">)</span> <span class="pre">/</span> <span class="pre">async</span> <span class="pre">AIOESPNow.__anext__(</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#aioespnow.AIOESPNow._aiter__" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="#aioespnow.AIOESPNow" title="aioespnow.AIOESPNow"><code class="xref any py py-class docutils literal notranslate"><span class="pre">AIOESPNow</span></code></a> also supports reading incoming messages by asynchronous
iteration using <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">for</span></code>; eg:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e</span> <span class="o">=</span> <span class="n">AIOESPNow</span><span class="p">()</span>
<span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">recv_till_halt</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">mac</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;halt&#39;</span><span class="p">:</span>
          <span class="k">break</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">recv_till_halt</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="broadcast-and-multicast">
<h2>Broadcast and Multicast<a class="headerlink" href="#broadcast-and-multicast" title="Permalink to this heading">¶</a></h2>
<p>All active ESPNow clients will receive messages sent to their MAC address and
all devices (<strong>except ESP8266 devices</strong>) will also receive messages sent to the
<em>broadcast</em> MAC address (<code class="docutils literal notranslate"><span class="pre">b'\xff\xff\xff\xff\xff\xff'</span></code>) or any multicast
MAC address.</p>
<p>All ESPNow devices (including ESP8266 devices) can also send messages to the
broadcast MAC address or any multicast MAC address.</p>
<p>To <a class="reference internal" href="#espnow.ESPNow.send" title="espnow.ESPNow.send"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> a broadcast message, the broadcast (or
multicast) MAC address must first be registered using
<a class="reference internal" href="#espnow.ESPNow.add_peer" title="espnow.ESPNow.add_peer"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">add_peer()</span></code></a>. <a class="reference internal" href="#espnow.ESPNow.send" title="espnow.ESPNow.send"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> will always return
<code class="docutils literal notranslate"><span class="pre">True</span></code> for broadcasts, regardless of whether any devices receive the
message. It is not permitted to encrypt messages sent to the broadcast
address or any multicast address.</p>
<p><strong>Note</strong>: <a class="reference internal" href="#espnow.ESPNow.send" title="espnow.ESPNow.send"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">ESPNow.send(None,</span> <span class="pre">msg)</span></code></a> will send to all registered
peers <em>except</em> the broadcast address. To send a broadcast or multicast
message, you must specify the broadcast (or multicast) MAC address as the
peer. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bcast</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">6</span>
<span class="n">e</span><span class="o">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">bcast</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bcast</span><span class="p">,</span> <span class="s2">&quot;Hello World!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="espnow-and-wifi-operation">
<h2>ESPNow and Wifi Operation<a class="headerlink" href="#espnow-and-wifi-operation" title="Permalink to this heading">¶</a></h2>
<p>ESPNow messages may be sent and received on any <a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active()</span></code></a>
<a class="reference internal" href="network.WLAN.html#network.WLAN" title="network.WLAN"><code class="xref any py py-class docutils literal notranslate"><span class="pre">WLAN</span></code></a> interface (<code class="docutils literal notranslate"><span class="pre">network.STA_IF</span></code> or <code class="docutils literal notranslate"><span class="pre">network.AP_IF</span></code>), even
if that interface is also connected to a wifi network or configured as an access
point. When an ESP32 or ESP8266 device connects to a Wifi Access Point (see
<a class="reference external" href="../esp32/quickref.html#networking">ESP32 Quickref</a>) the following things
happen which affect ESPNow communications:</p>
<ol class="arabic simple">
<li><p>Wifi Power-saving Mode (<a class="reference internal" href="network.WLAN.html#network.WLAN.PM_PERFORMANCE" title="network.WLAN.PM_PERFORMANCE"><code class="xref any py py-data docutils literal notranslate"><span class="pre">network.WLAN.PM_PERFORMANCE</span></code></a>)
is automatically activated and</p></li>
<li><p>The radio on the esp device changes wifi <code class="docutils literal notranslate"><span class="pre">channel</span></code> to match the channel
used by the Access Point.</p></li>
</ol>
<p><strong>Wifi Power-saving Mode:</strong> (see <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/wifi.html#esp32-wi-fi-power-saving-mode">Espressif Docs</a>) The power saving mode causes the
device to turn off the radio periodically (typically for hundreds of
milliseconds), making it unreliable in receiving ESPNow messages. This can be
resolved by either of:</p>
<ol class="arabic simple">
<li><p>Disabling the power-saving mode on the STA_IF interface;</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">sta.config(pm=sta.PM_NONE)</span></code></p></li>
</ul>
</li>
<li><p>Turning on the AP_IF interface, which will disable the power saving mode.
However, the device will then be advertising an active wifi access point.</p>
<ul class="simple">
<li><p>You <strong>may</strong> also choose to send your messages via the AP_IF interface, but
this is not necessary.</p></li>
<li><p>ESP8266 peers must send messages to this AP_IF interface (see below).</p></li>
</ul>
</li>
<li><p>Configuring ESPNow clients to retry sending messages.</p></li>
</ol>
<p><strong>Receiving messages from an ESP8266 device:</strong> Strangely, an ESP32 device
connected to a wifi network using method 1 or 2 above, will receive ESPNow
messages sent to the STA_IF MAC address from another ESP32 device, but will
<strong>reject</strong> messages from an ESP8266 device!!!. To receive messages from an
ESP8266 device, the AP_IF interface must be set to <code class="docutils literal notranslate"><span class="pre">active(True)</span></code> <strong>and</strong>
messages must be sent to the AP_IF MAC address.</p>
<p><strong>Managing wifi channels:</strong> Any other ESPNow devices wishing to communicate with
a device which is also connected to a Wifi Access Point MUST use the same
channel. A common scenario is where one ESPNow device is connected to a wifi
router and acts as a proxy for messages from a group of sensors connected via
ESPNow:</p>
<p><strong>Proxy:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">espnow</span>

<span class="n">sta</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="n">wifi_reset</span><span class="p">()</span>  <span class="c1"># Reset wifi to AP off, STA on and disconnected</span>
<span class="n">sta</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;myssid&#39;</span><span class="p">,</span> <span class="s1">&#39;mypassword&#39;</span><span class="p">)</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">sta</span><span class="o">.</span><span class="n">isconnected</span><span class="p">():</span>  <span class="c1"># Wait until connected...</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">sta</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pm</span><span class="o">=</span><span class="n">sta</span><span class="o">.</span><span class="n">PM_NONE</span><span class="p">)</span>  <span class="c1"># ..then disable power saving</span>

<span class="c1"># Print the wifi channel used AFTER finished connecting to access point</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Proxy running on channel:&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">))</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">espnow</span><span class="o">.</span><span class="n">ESPNow</span><span class="p">();</span> <span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">peer</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Receive espnow messages and forward them to MQTT broker over wifi</span>
</pre></div>
</div>
<p><strong>Sensor:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span><span class="o">,</span> <span class="nn">espnow</span>

<span class="n">sta</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="n">wifi_reset</span><span class="p">()</span>   <span class="c1"># Reset wifi to AP off, STA on and disconnected</span>
<span class="n">sta</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>    <span class="c1"># Change to the channel used by the proxy above.</span>
<span class="n">peer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;0</span><span class="se">\xaa\xaa\xaa\xaa\xaa</span><span class="s1">&#39;</span>  <span class="c1"># MAC address of proxy</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">espnow</span><span class="o">.</span><span class="n">ESPNow</span><span class="p">();</span> <span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span>
<span class="n">e</span><span class="o">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">read_sensor</span><span class="p">()</span>
    <span class="n">e</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Other issues to take care with when using ESPNow with wifi are:</p>
<ul>
<li><p><strong>Set WIFI to known state on startup:</strong> MicroPython does not reset the wifi
peripheral after a soft reset. This can lead to unexpected behaviour. To
guarantee the wifi is reset to a known state after a soft reset make sure you
deactivate the STA_IF and AP_IF before setting them to the desired state at
startup, eg.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span><span class="o">,</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">wifi_reset</span><span class="p">():</span>   <span class="c1"># Reset wifi to AP_IF off, STA_IF on and disconnected</span>
  <span class="n">sta</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">);</span> <span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">ap</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">AP_IF</span><span class="p">);</span> <span class="n">ap</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
  <span class="k">while</span> <span class="ow">not</span> <span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">():</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
  <span class="n">sta</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>   <span class="c1"># For ESP8266</span>
  <span class="k">while</span> <span class="n">sta</span><span class="o">.</span><span class="n">isconnected</span><span class="p">():</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">sta</span><span class="p">,</span> <span class="n">ap</span>

<span class="n">sta</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="n">wifi_reset</span><span class="p">()</span>
</pre></div>
</div>
<p>Remember that a soft reset occurs every time you connect to the device REPL
and when you type <code class="docutils literal notranslate"><span class="pre">ctrl-D</span></code>.</p>
</li>
<li><p><strong>STA_IF and AP_IF always operate on the same channel:</strong> the AP_IF will change
channel when you connect to a wifi network; regardless of the channel you set
for the AP_IF (see <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_wifi.html#_CPPv419esp_wifi_set_config16wifi_interface_tP13wifi_config_t">Attention Note 3</a>
). After all, there is really only one wifi radio on the device, which is
shared by the STA_IF and AP_IF virtual devices.</p></li>
<li><p><strong>Disable automatic channel assignment on your wifi router:</strong> If the wifi
router for your wifi network is configured to automatically assign the wifi
channel, it may change the channel for the network if it detects interference
from other wifi routers. When this occurs, the ESP devices connected to the
wifi network will also change channels to match the router, but other
ESPNow-only devices will remain on the previous channel and communication will
be lost. To mitigate this, either set your wifi router to use a fixed wifi
channel or configure your devices to re-scan the wifi channels if they are
unable to find their expected peers on the current channel.</p></li>
<li><p><strong>MicroPython re-scans wifi channels when trying to reconnect:</strong> If the esp
device is connected to a Wifi Access Point that goes down, MicroPython will
automatically start scanning channels in an attempt to reconnect to the
Access Point. This means ESPNow messages will be lost while scanning for the
AP. This can be disabled by <code class="docutils literal notranslate"><span class="pre">sta.config(reconnects=0)</span></code>, which will also
disable the automatic reconnection after losing connection.</p></li>
<li><p>Some versions of the ESP IDF only permit sending ESPNow packets from the
STA_IF interface to peers which have been registered on the same wifi
channel as the STA_IF:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ESPNOW: Peer channel is not equal to the home channel, send fail!
</pre></div>
</div>
</li>
</ul>
</section>
<section id="espnow-and-sleep-modes">
<h2>ESPNow and Sleep Modes<a class="headerlink" href="#espnow-and-sleep-modes" title="Permalink to this heading">¶</a></h2>
<p>The <a class="reference internal" href="machine.html#machine.lightsleep" title="machine.lightsleep"><code class="xref any py py-func docutils literal notranslate"><span class="pre">machine.lightsleep([time_ms])</span></code></a> and
<a class="reference internal" href="machine.html#machine.deepsleep" title="machine.deepsleep"><code class="xref any py py-func docutils literal notranslate"><span class="pre">machine.deepsleep([time_ms])</span></code></a> functions can be used to put
the ESP32 and peripherals (including the WiFi and Bluetooth radios) to sleep.
This is useful in many applications to conserve battery power. However,
applications must disable the WLAN peripheral (using
<a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active(False)</span></code></a>) before entering light or deep sleep (see
<a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/sleep_modes.html">Sleep Modes</a>).
Otherwise the WiFi radio may not be initialised properly after wake from
sleep. If the <code class="docutils literal notranslate"><span class="pre">STA_IF</span></code> and <code class="docutils literal notranslate"><span class="pre">AP_IF</span></code> interfaces have both been set
<a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active(True)</span></code></a> then both interfaces should be set
<a class="reference internal" href="network.WLAN.html#network.WLAN.active" title="network.WLAN.active"><code class="xref any py py-meth docutils literal notranslate"><span class="pre">active(False)</span></code></a> before entering any sleep mode.</p>
<p><strong>Example:</strong> deep sleep:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span><span class="o">,</span> <span class="nn">machine</span><span class="o">,</span> <span class="nn">espnow</span>

<span class="n">sta</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="n">wifi_reset</span><span class="p">()</span>            <span class="c1"># Reset wifi to AP off, STA on and disconnected</span>
<span class="n">peer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;0</span><span class="se">\xaa\xaa\xaa\xaa\xaa</span><span class="s1">&#39;</span>   <span class="c1"># MAC address of peer</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">espnow</span><span class="o">.</span><span class="n">ESPNow</span><span class="p">()</span>
<span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>                  <span class="c1"># Register peer on STA_IF</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sending ping...&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;ping&#39;</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ping failed!&#39;</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>                 <span class="c1"># Disable the wifi before sleep</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Going to sleep...&#39;</span><span class="p">)</span>
<span class="n">machine</span><span class="o">.</span><span class="n">deepsleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>          <span class="c1"># Sleep for 10 seconds then reboot</span>
</pre></div>
</div>
<p><strong>Example:</strong> light sleep:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">network</span><span class="o">,</span> <span class="nn">machine</span><span class="o">,</span> <span class="nn">espnow</span>

<span class="n">sta</span><span class="p">,</span> <span class="n">ap</span> <span class="o">=</span> <span class="n">wifi_reset</span><span class="p">()</span>            <span class="c1"># Reset wifi to AP off, STA on and disconnected</span>
<span class="n">sta</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">peer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;0</span><span class="se">\xaa\xaa\xaa\xaa\xaa</span><span class="s1">&#39;</span>   <span class="c1"># MAC address of peer</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">espnow</span><span class="o">.</span><span class="n">ESPNow</span><span class="p">()</span>
<span class="n">e</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">)</span>                  <span class="c1"># Register peer on STA_IF</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sending ping...&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;ping&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ping failed!&#39;</span><span class="p">)</span>
  <span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>               <span class="c1"># Disable the wifi before sleep</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Going to sleep...&#39;</span><span class="p">)</span>
  <span class="n">machine</span><span class="o">.</span><span class="n">lightsleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>       <span class="c1"># Sleep for 10 seconds</span>
  <span class="n">sta</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">sta</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>           <span class="c1"># Wifi loses config after lightsleep()</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright - The MicroPython Documentation is Copyright © 2014-2024, Damien P. George, Paul Sokolovsky, and contributors.
      <span class="lastupdated">Last updated on 05 Mar 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Language and External Links</span>
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Language</dt>
      <dd>
        <a href="https://openmv.io">English</a>
      </dd>
      <dd>
        <a href="http://doc.singtown.cc">中文</a>
      </dd>
    </dl>
    <hr/>
    <dl>
      <dt>External links</dt>
      <dd>
        <a href="https://openmv.io">openmv.io</a>
      </dd>
      <dd>
        <a href="http://forums.openmv.io">forums.openmv.io</a>
      </dd>
      <dd>
        <a href="https://github.com/openmv/openmv">github.com/openmv/openmv</a>
      </dd>
      <dd>
        <a href="http://micropython.org">micropython.org</a>
      </dd>
      <dd>
        <a href="http://forum.micropython.org">forum.micropython.org</a>
      </dd>
      <dd>
        <a href="https://github.com/micropython/micropython">github.com/micropython/micropython</a>
      </dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>